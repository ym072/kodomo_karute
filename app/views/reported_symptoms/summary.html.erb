<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>medical record - 症状記録</title>
</head>
<body>
  <main class="login-main">
  <div class="summary-header">
    <h2>症状サマリー</h2>
  </div>

  <div class="tabs-wrap">
  <div class="tabs">
  <%= link_to "今日",
    summary_kid_reported_symptoms_path(@kid, tab: "today"),
    class: "tab #{@tab == 'today' ? 'active' : ''}" %>

  <%= link_to "全期間",
    summary_kid_reported_symptoms_path(@kid, tab: "all"),
    class: "tab #{@tab == 'all' ? 'active' : ''}" %>
  </div>
  
  <div class="tab-content">
  <% if @tab == "today" %>
    
    <h3><%= Date.today %>（発症 <%= @day_count %> 日目）</h3>

    <% if @latest_temperature %>
      <p>
        最新体温：
        <%= @latest_temperature.body_temperature %>℃
        （<%= l @latest_temperature.recorded_at, format: :short %>）
      </p>
      <% else %>
        <p>本日の体温記録はありません</p>
    <% end %>

    <% if @vomit_count > 0 %>
      <p>
        嘔吐：<%= @vomit_count %>回
         （<%= @symptom_day_counts[SymptomName.find_by(name: "嘔吐").id] %>日目）
      </p>
    <% end %>

    <% if @diarrhea_count > 0 %>
      <p>
        便：<%= @diarrhea_count %>回
         （<%= @symptom_day_counts[SymptomName.find_by(name: "便").id] %>日目）
      </p>
    <% end %>

    <ul>
      <% @today_symptom_names.each do |s| %>
        <% next if ["嘔吐", "便"].include?(s.symptom_name.name) %>

        <li>
          <%= s.symptom_name.name %>:
          <%= @symptom_day_counts[s.symptom_name_id] %>日目
        </li>
      <% end %>
    </ul>
  <% end %>

  <% if @tab == "all" %>
    <div class="symptom-legend">
      <% @symptom_slots.each do |key, label| %>
        <div class="legend-item">
          <span class="legend-color <%= key %>"></span>
          <span class="legend-label"><%= label %></span>
        </div>
      <% end %>
    </div>

    <div class="weekly-matrix">

      <% [:last, :this].each do |week_key| %>
        <div class="week-column">
          <h3><%= week_key == :last ? "先週" : "今週" %></h3>

          <% @weeks[week_key].each do |date| %>
            <div class="day-row">
              <div class="weekday">
                <%= date.strftime("%a") %>
              </div>

              <div class="symptom-cells">
                <% @symptom_slots.each do |key, label| %>
                  <div class="symptom-cell <%= "active #{key}" if @matrix[date][key] %>">
                  </div>
                <% end %>
              </div>
            </div>

          <% end %>

        </div>
      <% end %>
    </div>

    <div class="symptom-trend">
      <h3>症状の推移</h3>

      <canvas id="symptomTrendChart"
        data-chart="<%= j @chart_data.to_json %>">
      </canvas>

      <script type="module">
        import { renderSymptomTrendChart } from "charts/symptom_trend_chart";

        document.addEventListener("DOMContentLoaded", () => {
          const canvas = document.getElementById("symptomTrendChart");
          const data = <%= raw @chart_data.to_json %>;
          renderSymptomTrendChart(canvas, data);
        });
      </script>
    </div>

  <% end %>
  </div>
  </div>

  <div class="footer">
    <p>
      <%= @kid.name %>
    </p>
  </div>
  </main>
</body>
</html>
